<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>–§–∏—à–∏–Ω–≥–∫–µ “õ–∞—Ä—Å—ã –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="container">
    <h1>–§–∏—à–∏–Ω–≥–∫–µ “õ–∞—Ä—Å—ã —Ç–µ–∫—Å–µ—Ä—É</h1>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
      <div>
        <button onclick="setLanguage('kk')">üá∞üáø “ö–∞–∑–∞“õ—à–∞</button>
        <button onclick="setLanguage('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
      </div>
      <div>
        <button onclick="toggleTheme()">üåó –†–µ–∂–∏–º</button>
      </div>
    </div>

    <form action="/analyze" method="POST" enctype="multipart/form-data">
      <input type="file" name="file" required>
      <button type="submit">–¢–µ–∫—Å–µ—Ä—É</button>
    </form>

    <% if (result) { %>
      <div class="result">

        <% if (result.riskLevel) { %>
          <div class="risk <%= result.riskLevel.toLowerCase() %>">
            “ö–∞—É—ñ–ø –¥–µ“£–≥–µ–π—ñ: <strong><%= result.riskLevel %></strong>
          </div>
        <% } %>

        <h2>–ù”ô—Ç–∏–∂–µ:</h2>

        <% if (result.error) { %>
          <div class="block danger">
            <p><%= result.error %></p>
          </div>

        <% } else if (result.type === 'image') { %>
          <div class="block warning">
            <p><strong>üñº –ú”ô—Ç—ñ–Ω:</strong></p>
            <pre><%= result.text %></pre>
            <p><strong>‚ö†Ô∏è –ö“Ø–¥—ñ–∫—Ç—ñ —Å”©–∑–¥–µ—Ä:</strong> <%= result.suspicious.join(', ') %></p>
          </div>

        <% } else if (result.type === 'eml') { %>
          <div class="block">
            <p><strong>üë§ –ö—ñ–º–Ω–µ–Ω:</strong> <%= result.from %></p>
            <p><strong>üìå –¢–∞“õ—ã—Ä—ã–ø:</strong> <%= result.subject %></p>
            <p><strong>üîó –°—ñ–ª—Ç–µ–º–µ–ª–µ—Ä:</strong></p>
            <ul>
              <% result.urls.forEach(url => { %>
                <li><%= url %></li>
              <% }) %>
            </ul>
          </div>

          <div class="block warning">
            <p><strong>üì° –î–æ–º–µ–Ω:</strong> <%= result.domain %></p>
            <p><strong>‚úÖ SPF:</strong> <%= result.spf %></p>
            <p><strong>üîê DKIM:</strong> <%= result.dkim %></p>
            <p><strong>üì¨ DMARC:</strong> <%= result.dmarc %></p>
          </div>

          <h3>üõ° VirusTotal –¢–µ–∫—Å–µ—Ä—É:</h3>
          <% if (result.vtResults && result.vtResults.length > 0) { %>
            <% result.vtResults.forEach(r => { %>
              <div class="block <%= r.vt.malicious > 1 ? 'danger' : (r.vt.suspicious > 0 ? 'warning' : 'safe') %>">
                <p><strong>üîó <%= r.url %></strong></p>
                <% if (r.vt.error) { %>
                  <p style="color:red;">‚ö†Ô∏è <%= r.vt.error %></p>
                <% } else { %>
                  <ul>
                    <% for (const [key, value] of Object.entries(r.vt)) { %>
                      <li><strong><%= key %>:</strong> <%= value %></li>
                    <% } %>
                  </ul>
                <% } %>
              </div>
            <% }) %>
          <% } else { %>
            <p style="color:gray;">üîç VirusTotal –Ω”ô—Ç–∏–∂–µ—Å—ñ —Ç–∞–±—ã–ª–º–∞–¥—ã –Ω–µ–º–µ—Å–µ —Å—ñ–ª—Ç–µ–º–µ–ª–µ—Ä –∞–Ω—ã“õ—Ç–∞–ª–º–∞–¥—ã.</p>
          <% } %>

          <!-- üì• PDF –∂“Ø–∫—Ç–µ—É -->
          <div style="margin-top: 20px;">
            <a href="/download?
              from=<%= encodeURIComponent(result.from) %>
              &subject=<%= encodeURIComponent(result.subject) %>
              &domain=<%= result.domain %>
              &spf=<%= result.spf %>
              &dkim=<%= result.dkim %>
              &dmarc=<%= result.dmarc %>
              &risk=<%= result.riskLevel %>
              &urls=<%= encodeURIComponent(result.urls.join(',')) %>"
              target="_blank">
              <button>üì• PDF –∂“Ø–∫—Ç–µ—É</button>
            </a>
          </div>

        <% } %>
      </div>
    <% } %>
  </div>

  <script>
    function setLanguage(lang) {
      const url = new URL(window.location.href);
      url.searchParams.set('lang', lang);
      window.location.href = url.toString();
    }

    function toggleTheme() {
      const body = document.body;
      const isLight = body.classList.toggle('light-mode');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    }

    window.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('theme');
      if (saved === 'light') {
        document.body.classList.add('light-mode');
      }

      // üìã –°—É—Ä–µ—Ç—Ç—ñ Ctrl+V –∞—Ä“õ—ã–ª—ã –∂“Ø–∫—Ç–µ—É
      document.addEventListener("paste", function (event) {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        for (const item of items) {
          if (item.type.indexOf("image") === 0) {
            const blob = item.getAsFile();
            const fileInput = document.querySelector('input[type="file"]');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(blob);
            fileInput.files = dataTransfer.files;
            alert("üì∑ –°–∫—Ä–∏–Ω—à–æ—Ç “õ–æ–π—ã–ª–¥—ã! –ï–Ω–¥—ñ '–¢–µ–∫—Å–µ—Ä—É' –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å.");
          }
        }
      });
    });
  </script>
</body>
</html>

